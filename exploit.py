#!/usr/bin/env python3
"""
ğŸ¯ SQLi Exploitation - Command Line Interface
ØªØ´ØºÙŠÙ„ Ø³Ù‡Ù„: python exploit.py <URL>
"""

import sys
import io
import time
import argparse
from pathlib import Path

# Fix Unicode encoding on Windows
if sys.platform == 'win32':
    sys.stdout = io.TextIOWrapper(sys.stdout.buffer, encoding='utf-8')
    sys.stderr = io.TextIOWrapper(sys.stderr.buffer, encoding='utf-8')

# Add project root
sys.path.insert(0, str(Path(__file__).parent))

from core.target import Vulnerability
from exploits.sqli_exploit import SQLiExploit
from datetime import datetime


def exploit_url(url, verbose=False, no_sqlmap=False):
    """
    Ø§Ø³ØªØ®Ø±Ø¬ Ø§Ù„Ù€ URL ÙˆØ´ØºÙ„ Ø§Ù„Ù€ exploitation ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
    
    Args:
        url: Target URL
        verbose: Ø§Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø£ÙƒØªØ±
        no_sqlmap: ØªØ®Ø·ÙŠ SQLMap (Ø£Ø³Ø±Ø¹)
    """
    
    print(f"""
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘            ğŸš€ SQLi Exploitation Engine                    â•‘
â•‘              (Automatic Mode)                             â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
""")
    
    print(f"[*] Target: {url}")
    print(f"[*] Mode: Automatic")
    if no_sqlmap:
        print(f"[*] SQLMap: DISABLED (Fast mode)")
    else:
        print(f"[*] SQLMap: ENABLED (Full scan)")
    print()
    
    try:
        # Create vulnerability object with required fields
        vuln = Vulnerability(
            vuln_type='sqli',
            severity='high',
            url=url,
            parameter='',  # Will be detected automatically
            payload='',    # Will be generated automatically
            evidence='',   # Will be filled during exploitation
            timestamp=datetime.now()
        )
        
        # Configure exploit
        config = {
            'sqlmap': {
                'level': 5,
                'risk': 3,
                'threads': 10,
                'timeout': 300  # 5 minutes
            },
            'max_threads': 10,
            'layer2_timeout': 30 if not no_sqlmap else 0,
            'early_exit': True,
            'skip_layer2': no_sqlmap  # Skip SQLMap if requested
        }
        
        # Run exploitation
        exploit = SQLiExploit(config=config)
        
        print("[*] Starting exploitation...\n")
        start_time = time.time()
        result = exploit.execute(vuln)
        elapsed = time.time() - start_time
        
        # Display results
        print("\n" + "="*70)
        print("ğŸ“Š RESULTS")
        print("="*70)
        
        if result['success']:
            print(f"\nâœ… VULNERABLE - SQL Injection Found!\n")
        else:
            print(f"\nâŒ Not vulnerable or could not exploit\n")
        
        print(f"â±ï¸  Total Time: {elapsed:.1f}s")
        print(f"ğŸ“ Layers Used: {', '.join(result['layers_used'])}")
        
        if 'step_times' in result:
            print(f"\nâ³ Step Breakdown:")
            for step, t in result['step_times'].items():
                print(f"   â€¢ {step}: {t:.1f}s")
        
        # Show evidence
        print(f"\nğŸ“‹ Evidence:")
        print("-" * 70)
        if result['evidence']:
            evidence_lines = result['evidence'].split('\n')
            for line in evidence_lines[:20]:  # Show first 20 lines
                print(line)
            if len(evidence_lines) > 20:
                print(f"   ... ({len(evidence_lines) - 20} more lines)")
        else:
            print("   (No evidence)")
        print("-" * 70)
        
        # Show additional data if verbose
        if verbose and result['data']:
            print(f"\nğŸ” Additional Data:")
            print("-" * 70)
            for key, value in result['data'].items():
                if value:
                    print(f"   {key}: {str(value)[:100]}")
        
        print("\n" + "="*70)
        
        # Return success status
        return result['success']
    
    except Exception as e:
        print(f"âŒ Error: {e}")
        if verbose:
            import traceback
            traceback.print_exc()
        return False


def main():
    """Main CLI entry point"""
    
    parser = argparse.ArgumentParser(
        description='SQLi Exploitation - Automatic Mode',
        usage='%(prog)s <URL> [options]',
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog='''
EXAMPLES:
  # Basic usage
  python exploit.py http://target.com/page.php?id=1
  
  # With verbose output
  python exploit.py http://target.com/page.php?id=1 -v
  
  # Fast mode (skip SQLMap)
  python exploit.py http://target.com/page.php?id=1 --fast
  
  # Full URL with query params
  python exploit.py "http://localhost/page.php?id=1&category=test"

NOTES:
  - Automatic exploitation with all 8 blind SQLi techniques
  - Early exit when vulnerability found
  - Returns exit code 0 if vulnerable, 1 if not
        '''
    )
    
    # Positional argument for URL
    parser.add_argument('url',
                        nargs='?',
                        help='Target URL to exploit')
    
    # Optional arguments
    parser.add_argument('-v', '--verbose',
                        action='store_true',
                        help='Ø§Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø£ÙƒØªØ±')
    
    parser.add_argument('--fast',
                        action='store_true',
                        help='ØªØ®Ø·ÙŠ SQLMap (Ø£Ø³Ø±Ø¹ØŒ Ù„ÙƒÙ† Ø£Ù‚Ù„ Ø¯Ù‚Ø©)')
    
    parser.add_argument('--timeout',
                        type=int,
                        default=300,
                        help='Timeout Ø¨Ø§Ù„Ø«ÙˆØ§Ù†ÙŠ (Ø§ÙØªØ±Ø§Ø¶ÙŠ: 300)')
    
    args = parser.parse_args()
    
    # Check if URL provided
    if not args.url:
        parser.print_help()
        print("\n" + "="*70)
        print("âŒ Error: URL required!")
        print("="*70)
        print("\nExample usage:")
        print("  python exploit.py http://target.com/page.php?id=1")
        sys.exit(1)
    
    # Run exploitation
    success = exploit_url(
        url=args.url,
        verbose=args.verbose,
        no_sqlmap=args.fast
    )
    
    # Exit with appropriate code
    sys.exit(0 if success else 1)


if __name__ == '__main__':
    main()
