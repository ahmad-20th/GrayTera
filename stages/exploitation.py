from core.stage import Stage
from core.target import Target, Vulnerability
from exploits.exploit_registry import ExploitRegistry


class ExploitationStage(Stage):
    """Stage 3: Exploitation"""
    
    def __init__(self, config: dict):
        super().__init__("Exploitation")
        self.config = config
        self.auto_exploit = config.get('auto_exploit', False)
        self.exploit_registry = ExploitRegistry()
    
    def execute(self, target: Target) -> bool:
        """Attempt to exploit discovered vulnerabilities"""
        self.notify("start", f"Attempting to exploit {len(target.vulnerabilities)} vulnerabilities")
        
        if not target.vulnerabilities:
            self.notify("warning", "No vulnerabilities to exploit")
            return True
        
        try:
            if self.auto_exploit:
                self._auto_exploit_all(target)
            else:
                self._interactive_exploit(target)
            
            self.notify("complete", f"Successfully exploited {len(target.exploited)} vulnerabilities")
            return True
            
        except Exception as e:
            self.notify("error", str(e))
            return False
    
    def _auto_exploit_all(self, target: Target):
        """Automatically exploit all vulnerabilities"""
        for vuln in target.vulnerabilities:
            self._attempt_exploit(target, vuln)
    
    def _interactive_exploit(self, target: Target):
        """Let user choose which vulnerabilities to exploit"""
        if not target.vulnerabilities:
            self.notify("warning", "No vulnerabilities to exploit")
            return
        
        self.notify("info", f"Discovered {len(target.vulnerabilities)} vulnerabilities:")
        for idx, vuln in enumerate(target.vulnerabilities, 1):
            self.notify("info", f"  {idx}. [{vuln.severity.upper()}] {vuln.vuln_type} at {vuln.url}")
        
        print("\nEnter vulnerability numbers to exploit (comma-separated, or 'all'):")
        choice = input("> ").strip()
        
        if choice.lower() == 'all':
            indices = range(len(target.vulnerabilities))
        else:
            try:
                indices = [int(x.strip()) - 1 for x in choice.split(',') if x.strip()]
                indices = [i for i in indices if 0 <= i < len(target.vulnerabilities)]
            except ValueError:
                self.notify("error", "Invalid input. Please enter numbers.")
                return
        
        for idx in indices:
            if 0 <= idx < len(target.vulnerabilities):
                vuln = target.vulnerabilities[idx]
                self._attempt_exploit(target, vuln)
    
    def _attempt_exploit(self, target: Target, vuln: Vulnerability):
        """Attempt to exploit a single vulnerability"""
        exploit = self.exploit_registry.get_exploit(vuln.vuln_type)
        
        if not exploit:
            self.notify("warning", f"No exploit available for {vuln.vuln_type}")
            return
        
        try:
            result = exploit.execute(vuln)
            if result['success']:
                target.add_exploit_result(result)
                self.notify("exploit_success", {
                    'type': vuln.vuln_type,
                    'url': vuln.url,
                    'result': result
                })
            else:
                self.notify("exploit_failed", f"{vuln.vuln_type} at {vuln.url}")
                
        except Exception as e:
            self.notify("error", f"Exploit failed: {e}")
