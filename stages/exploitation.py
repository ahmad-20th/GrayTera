from core.stage import Stage
from core.target import Target, Vulnerability
from exploits.exploit_registry import ExploitRegistry
from utils.cve_mapper import CVEMapper


class ExploitationStage(Stage):
    """Stage 3: Exploitation"""
    
    def __init__(self, config: dict):
        super().__init__("Exploitation")
        self.config = config
        self.auto_exploit = config.get('auto_exploit', False)
        self.exploit_registry = ExploitRegistry()
    
    def execute(self, target: Target) -> bool:
        self.notify("start", f"Attempting to exploit {len(target.vulnerabilities)} vulnerabilities")
        
        if not target.vulnerabilities:
            self.notify("warning", "No vulnerabilities to exploit")
            return True
        
        try:
            if self.auto_exploit:
                self._auto_exploit_all(target)
            else:
                self._interactive_exploit(target)
            
            self.notify("complete", f"Successfully exploited {len(target.exploited)} vulnerabilities")
            return True
            
        except Exception as e:
            self.notify("error", str(e))
            return False
    
    def _auto_exploit_all(self, target: Target):
        """Automatically exploit all CVEs"""
        # Group vulnerabilities by CVE
        cve_map = CVEMapper.deduplicate_by_cve(target.vulnerabilities)
        for cve_id, finding in cve_map.items():
            self._attempt_exploit_cve(target, cve_id, finding)
    
    def _interactive_exploit(self, target: Target):
        """Let user choose which CVEs to exploit"""
        if not target.vulnerabilities:
            self.notify("warning", "No vulnerabilities to exploit")
            return
        
        # Group vulnerabilities by CVE
        cve_map = CVEMapper.deduplicate_by_cve(target.vulnerabilities)
        cves_list = list(cve_map.items())
        
        self.notify("info", f"Discovered {len(cves_list)} CVE(s) to exploit:")
        for idx, (cve_id, finding) in enumerate(cves_list, 1):
            affected_params = finding['affected_parameters']
            param_count = len(affected_params)
            unique_urls = len(set(p['url'] for p in affected_params))
            self.notify("info", f"  {idx}. [{finding['severity'].upper()}] {cve_id} ({param_count} parameters across {unique_urls} subdomain(s))")
            # Show detailed breakdown
            for param_info in affected_params:
                param = param_info['parameter']
                url = param_info['url']
                self.notify("info", f"      - {param} @ {url}")
        
        print("\nEnter CVE numbers to exploit (comma-separated, or 'all'):")
        choice = input("> ").strip()
        
        if choice.lower() == 'all':
            indices = range(len(cves_list))
        else:
            try:
                indices = [int(x.strip()) - 1 for x in choice.split(',') if x.strip()]
                indices = [i for i in indices if 0 <= i < len(cves_list)]
            except ValueError:
                self.notify("error", "Invalid input. Please enter numbers.")
                return
        
        for idx in indices:
            if 0 <= idx < len(cves_list):
                cve_id, finding = cves_list[idx]
                self._attempt_exploit_cve(target, cve_id, finding)
    
    def _attempt_exploit_cve(self, target: Target, cve_id: str, finding: dict):
        """Attempt to exploit all instances of a CVE"""
        vuln_type = finding['vuln_type']
        exploit = self.exploit_registry.get_exploit(vuln_type)
        
        if not exploit:
            self.notify("warning", f"No exploit available for {vuln_type} (CVE: {cve_id})")
            return
        
        try:
            # Pass all affected parameters to the exploit
            result = exploit.execute_cve(cve_id, finding)
            if result['success']:
                target.add_exploit_result(result)
                success_count = len(result.get('exploited_parameters', []))
                self.notify("exploit_success", {
                    'type': vuln_type,
                    'cve_id': cve_id,
                    'url': finding['url'],
                    'parameters_exploited': success_count,
                    'result': result
                })
            else:
                self.notify("exploit_failed", f"{vuln_type} (CVE: {cve_id})")
                
        except Exception as e:
            self.notify("error", f"Exploit failed for {cve_id}: {e}")
