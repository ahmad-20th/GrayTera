#!/usr/bin/env python3
"""
Test Script for SQLi Exploitation
Run: python test_sqli.py
"""

from core.target import Vulnerability
from exploits.sqli_exploit import SQLiExploit
from datetime import datetime
import yaml

def test_sqli_exploit():
    """Test the 2-layer SQLi exploitation"""
    
    # Load config
    try:
        with open('config.yaml', 'r') as f:
            config = yaml.safe_load(f)
    except:
        config = {}
    
    # Create test vulnerability (URL only!)
    test_url = 'http://testphp.vulnweb.com/artists.php?artist=1'
    
    vuln = Vulnerability(
        vuln_type='sqli',
        severity='high',
        url=test_url,
        parameter='',  # Ø³ÙŠØªÙ… Ø§ÙƒØªØ´Ø§ÙÙ‡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
        payload='',    # Ø³ÙŠØªÙ… Ø§ÙƒØªØ´Ø§ÙÙ‡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
        evidence='Potential SQL Injection detected by scanner',
        timestamp=datetime.now()
    )
    
    print("\n" + "="*70)
    print("ğŸ§ª Testing SQL Injection Exploitation")
    print("="*70)
    print(f"Target: {test_url}")
    print(f"This will take 5-10 minutes with SQLMap...")
    print("="*70 + "\n")
    
    # Run exploitation
    exploit = SQLiExploit(config=config.get('exploitation', {}))
    result = exploit.execute(vuln)
    
    # Print results
    print("\n" + "="*70)
    print("ğŸ“Š RESULTS")
    print("="*70)
    print(f"âœ“ Success: {result['success']}")
    print(f"âœ“ Layers Used: {result['layers_used']}")
    print(f"âœ“ Time Elapsed: {result['time_elapsed']:.1f}s")
    print("="*70)
    
    print(f"\nğŸ“„ Evidence:\n")
    print(result['evidence'])
    
    if result.get('data'):
        print(f"\nğŸ“¦ Data Keys: {list(result['data'].keys())}")
        
        # Print SQLMap results if available
        if 'sqlmap' in result['data']:
            sqlmap_data = result['data']['sqlmap']
            print(f"\nğŸ” SQLMap Details:")
            print(f"  â€¢ Vulnerable: {sqlmap_data.get('vulnerable', False)}")
            print(f"  â€¢ DBMS: {sqlmap_data.get('dbms', 'Unknown')}")
            print(f"  â€¢ Injection Types: {', '.join(sqlmap_data.get('injection_types', []))}")
    
    print("\n" + "="*70)
    print("âœ… Test Complete!")
    print("="*70 + "\n")
    
    return result

if __name__ == '__main__':
    try:
        test_sqli_exploit()
    except KeyboardInterrupt:
        print("\n\nâš ï¸  Test interrupted by user")
    except Exception as e:
        print(f"\n\nâŒ Error: {e}")
        import traceback
        traceback.print_exc()
